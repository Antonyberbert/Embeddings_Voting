---
title: "H1 energyact"
output: html_document
date: "2023-12-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Install and load necessary packages
packages <- c("devtools","here","dplyr","tidyverse","readxl","writexl","hunspell")
for (package in packages) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
}
lapply(packages,library, character.only=T)
```

```{r}
#Install and load embedR
if (!requireNamespace("embedR", quietly = TRUE)) {
    # If not installed, install it using devtools
    devtools::install_github("dwulff/embedR")
}

library("embedR")
```

```{r}
#read in final dataset
energyact_fin <- read_xlsx(here::here("data","energyact_final.xlsx"))

#load embeddings as R object
embedding <- readRDS(here::here("data","embedding.rds"))

#load result as R object
resultfin <- readRDS(here::here("data","resultfin_emb.rds"))
```

```{r}
#Import Excel with cluster assignment for H1. 
#1 = economy
#2 = environmental protection
#3 = other
H1_df <- read_xlsx(here::here("data","embedR_resfin.xlsx"))
```

```{r}
# Split the 'group_texts' into individual words and create a new dataframe
H1_mapping <- H1_df %>%
  separate_rows(group_texts, sep = ",") %>%
  mutate(group_texts = trimws(group_texts)) %>%
  distinct(group_texts, H1)

energyact_fin_updated <- merge(energyact_fin, H1_mapping, by.x = "word", by.y = "group_texts", all.x = TRUE)

unmatched <- energyact_fin_updated[is.na(energyact_fin_updated$H1), "word"]

print(unmatched)
```


```{r}
#Check if the results are correct
# Sample a few rows to inspect
set.seed(26)  # Setting seed for reproducibility
sampled_rows <- sample_n(energyact_fin_updated, 10)
print(sampled_rows)

#Check if frequency tables match
table(energyact_fin_updated$H1)

# Sum of group_size for H1 value 1
sum_group_size_H1_1 <- sum(H1_df$group_size[H1_df$H1 == 1], na.rm = TRUE)

# Sum of group_size for H1 value 2
sum_group_size_H1_2 <- sum(H1_df$group_size[H1_df$H1 == 2], na.rm = TRUE)

# Sum of group_size for H1 value 3
sum_group_size_H1_3 <- sum(H1_df$group_size[H1_df$H1 == 3], na.rm = TRUE)

# Printing the results
cat("Sum of group_size for H1 = 1:", sum_group_size_H1_1, "\n")
cat("Sum of group_size for H1 = 2:", sum_group_size_H1_2, "\n")
cat("Sum of group_size for H1 = 3:", sum_group_size_H1_3, "\n")

#Lastly delete rows where H1 == 4
energyact_fin_updated <- energyact_fin_updated[energyact_fin_updated$H1 != 4, ]
```

```{r}
#How many people that mentioned economy words (H1=1) voted for (1) or against (0) the law
# Filter rows where H1 = 1 (Economy words)
economy_words <- subset(energyact_fin_updated, H1 == 1)

# Create a contingency table for economy words vs intended vote
economy_vote_table <- table(economy_words$intendedVote)

#Create percentages table as absolute numbers are different
economy_vote_perc <- prop.table(economy_vote_table) * 100

# Print the table
print("Percentage Table for Economy Words (H1 = 1) and Voting:")
print(economy_vote_perc)

#How many people that mentioned environmental protection words (H1=2) voted for (1) or against (0) the law

# Filter rows where H1 = 2 (Environmental protection words)
env_prot_words <- subset(energyact_fin_updated, H1 == 2)

# Create a contingency table for environmental protection words vs intended vote
env_prot_vote_table <- table(env_prot_words$intendedVote)

#Create percentages table as absolute numbers are different
env_prot_vote_perc <- prop.table(env_prot_vote_table) * 100
# Print the table
print("Table for Environmental Protection Words (H1 = 2) and Voting:")
print(env_prot_vote_perc)
```

```{r}
#Create H1 Factor variable
#first recode H1
energyact_fin_updated$fH1 <- energyact_fin_updated$H1 - 1
# Convert to factor
energyact_fin_updated$fH1 <- factor(energyact_fin_updated$fH1, levels = c(0,1,2), labels= c("economy","environmental protection","other"))

# Subset for 'for' voters, including only fH1 == 0 and fH1 == 1
for_voters <- subset(energyact_fin_updated, intendedVote == 1 & fH1 %in% c("economy","environmental protection"))

# Subset for 'against' voters, including only fH1 == 0 and fH1 == 1
against_voters <- subset(energyact_fin_updated, intendedVote == 0 & fH1 %in% c("economy","environmental protection"))


# Calculate percentages for economy words among 'for' and 'against' voters
economy_words_for <- sum(for_voters$fH1 == "economy")
percentage_economy_for <- economy_words_for / nrow(for_voters) * 100
economy_words_against <- sum(against_voters$fH1 == "economy")
percentage_economy_against <- economy_words_against / nrow(against_voters) * 100

# Print the results
cat("Percentage of voters 'for' mentioning economy words:", percentage_economy_for, "%\n")
cat("Percentage of voters 'against' mentioning economy words:", percentage_economy_against, "%\n")
```

```{r}
# Calculate percentages for environmental protection words among 'for' and 'against' voters
env_protection_words_for <- sum(for_voters$fH1 == "environmental protection")
percentage_env_protection_for <- env_protection_words_for / nrow(for_voters) * 100

env_protection_words_against <- sum(against_voters$fH1 == "environmental protection")
percentage_env_protection_against <- env_protection_words_against / nrow(against_voters) * 100

# Print the results
cat("Percentage of voters 'for' mentioning environmental protection words:", percentage_env_protection_for, "%\n")
cat("Percentage of voters 'against' mentioning environmental protection words:", percentage_env_protection_against, "%\n")
```

```{r,eval=F,echo=F}
#Testing for significance using chi-squared test
# Contingency table for economy words (H1 = 1), excluding H1 = 3 and H1 = 4
economy_for <- sum(for_voters$H1 == 0)
economy_against <- sum(against_voters$H1 == 0)
economy_table <- matrix(c(economy_for, economy_against, nrow(for_voters) - economy_for - sum(for_voters$H1 !=2), nrow(against_voters) - economy_against - sum(against_voters$H1 !=2)), nrow = 2, byrow = TRUE, 
                        dimnames = list(c("Economy_Mentioned", "Economy_Not_Mentioned"),
                                        c("For", "Against")))

# Contingency table for environmental protection words (H1 = 2), excluding H1 = 3 and H1 = 4
env_prot_for <- sum(for_voters$H1 == 2)
env_prot_against <- sum(against_voters$H1 == 2)
env_prot_table <- matrix(c(env_prot_for, env_prot_against, nrow(for_voters) - env_prot_for - sum(for_voters$H1 %in% c(3, 4)), nrow(against_voters) - env_prot_against - sum(against_voters$H1 %in% c(3, 4))), nrow = 2, byrow = TRUE,
                         dimnames = list(c("EnvProt_Mentioned", "EnvProt_Not_Mentioned"),
                                         c("For", "Against")))

# Chi-squared test for economy words
chi_sq_test_economy <- chisq.test(economy_table)
print("Chi-squared test for economy words:")
print(chi_sq_test_economy)

# Chi-squared test for environmental protection words
chi_sq_test_env_prot <- chisq.test(env_prot_table)
print("Chi-squared test for environmental protection words:")
print(chi_sq_test_env_prot)
```

```{r}
#Logistic regression
# Exclude H1 = 2
filtered_data <- subset(energyact_fin_updated, fH1 != "other")

# Create binary variables for economy and environmental protection words
filtered_data$economy_mentioned <- as.numeric(filtered_data$fH1 == "economy")
filtered_data$env_prot_mentioned <- as.numeric(filtered_data$fH1 == "environmental protection")

# Logistic regression for economy words
logit_model_economy <- glm(intendedVote ~ economy_mentioned, family = "binomial", data = filtered_data)
summary(logit_model_economy)

#Odds Ratio
odds_ratio_economy <- exp(logit_model_economy$coefficients["economy_mentioned"])
print("Odds Ratio for economy_mentioned:")
print(odds_ratio_economy)

# Logistic regression for environmental protection words
logit_model_env_prot <- glm(intendedVote ~ env_prot_mentioned, family = "binomial", data = filtered_data)
summary(logit_model_env_prot)

#Odds Ratio
odds_ratio_env <- exp(logit_model_env_prot$coefficients["env_prot_mentioned"])
print("Odds Ratio for env_prot_mentioned:")
print(odds_ratio_env)
```
# Interpretation of Logistic Regression
## Intercepts
Both above 1, meaning that it was more likely that that a participant voted yes

## Economy
The Coefficient economy_mentioned is negative and means that mentioning economy words is associated with a decreased likelihood of voting for the law

## Environmental Protection
The Coefficient env_prot_mentioned is positive and means that mentioning environmental protection words is associated with a increased likelihood of voting for the law

```{r}
#Bonferroni correction for multiple testing
# Extract p-values
p_value_economy <- summary(logit_model_economy)$coefficients["economy_mentioned", "Pr(>|z|)"]
p_value_env_prot <- summary(logit_model_env_prot)$coefficients["env_prot_mentioned", "Pr(>|z|)"]

# Combine p-values into a vector
p_values <- c(economy = p_value_economy, env_prot = p_value_env_prot)

# Bonferroni correction
p_adjusted_bonferroni <- p.adjust(p_values, method = "bonferroni")

# Holm correction (another common method)
p_adjusted_holm <- p.adjust(p_values, method = "holm")

# Printing adjusted p-values
print("Adjusted P-Values (Bonferroni):")
print(p_adjusted_bonferroni)

print("Adjusted P-Values (Holm):")
print(p_adjusted_holm)
```
```{r}
#Calculating model fit (McFadden's R-squared)
calculate_mcfadden_r_squared <- function(model) {
  ll_full <- logLik(model)  # Log-likelihood of the full model
  ll_null <- logLik(glm(formula = intendedVote ~ 1, family = "binomial", data = model$data))  # Log-likelihood of the null model
  1 - as.numeric(ll_full / ll_null)
}

# McFadden’s R-squared for the economy model
r_squared_economy <- calculate_mcfadden_r_squared(logit_model_economy)
print("McFadden's R-squared for the Economy Model:")
print(r_squared_economy)

# McFadden’s R-squared for the environmental protection model
r_squared_env_prot <- calculate_mcfadden_r_squared(logit_model_env_prot)
print("McFadden's R-squared for the Environmental Protection Model:")
print(r_squared_env_prot)
```
```{r}
#Creating plot
# Tidy the logistic regression models
tidy_economy <- broom::tidy(logit_model_economy, conf.int = TRUE)
tidy_env_prot <- broom::tidy(logit_model_env_prot, conf.int = TRUE)

# Add a column to distinguish models
tidy_economy$model <- "Economy"
tidy_env_prot$model <- "Environmental Protection"

# Combine the data
combined_models <- rbind(tidy_economy, tidy_env_prot)

# Plot the coefficients with confidence intervals
ggplot(combined_models, aes(x = term, y = estimate, color = model)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  labs(x = "Term", y = "Estimate", title = "Coefficients of Logistic Regression Models") +
  theme_minimal() +
  coord_flip() +
  theme(legend.position = "bottom")

```





